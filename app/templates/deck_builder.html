{% extends 'base.html' %}

{% macro card_list(header, class, cards) %}
  <div class="card-list-divider">
    <p>{{ header }}</p>
  </div>
  
  <ul class="list-unstyled card-list sortable">
    {% for pack_card in cards %}
      {% set card = pack_card.cube_card %}
      <li
        class="card-list-item {{ class }}"
        data-front="{{ card.image_front() }}"
        {% if card.image_back() %}
          data-back="{{ card.image_back() }}"
        {% endif %}
      >
        {{ card.name() }}
      </li>
    {% endfor %}
  </ul>
{% endmacro %}

{% macro card_column(card_set) %}
  <div class="col">

    <!-- Header Row -->
    <div class="row">
      
      <div class="col col-3 text-center">
        <h5>
          Main Deck
          (<span id="maindeckCount">{{ card_set.maindeck().cards|length }}</span>)
        </h5>
      </div>

      <div class="col col-3 text-center">
        <h5>
          Sideboard
          (<span id="sideboardCount">{{ card_set.sideboard().cards|length }}</span>)
        </h5>
      </div>
      
    </div>
    <!-- END: Header Row -->

    <!-- Land Row -->
    <div class="row">
      
      <div class="col col-3 framed maindeck">
        {{ card_list('land', 'land-card', card_set.maindeck().land().cards) }}
      </div>
      
      <div class="col col-3 framed sideboard">
        {{ card_list('land', 'land-card', card_set.sideboard().land().cards) }}
      </div>

    </div>
    <!-- END: Land Row -->

    {% for cmc in range(8) %}

      {# Cards under this header #}
      {% if cmc == 7 %}
        {% set cards = card_set.cmc_gte(7) %}
        {% set cmc_string = '7+' %}
      {% else %}
        {% set cards = card_set.cmc(cmc) %}
        {% set cmc_string = cmc|string %}
      {% endif %}

      {# Maindeck/Sideboard breakdown #}
      {% set maindeck = cards.maindeck() %}
      {% set sideboard = cards.sideboard() %}

      <div class="row">
        <div class="col col-3 framed maindeck">
          {{ card_list('creatures '+cmc_string, 'creature', maindeck.creatures().cards) }}
          {{ card_list('other '+cmc_string, 'other', maindeck.other().cards) }}
        </div>

        <div class="col col-3 framed sideboard">
          {{ card_list('creatures '+cmc_string, 'creature', sideboard.creatures().cards) }}
          {{ card_list('other '+cmc_string, 'other', sideboard.other().cards) }}
        </div>
      </div>

    {% endfor %}
  </div>
{% endmacro %}


{% block content %}
  <div class="row">
    <div class="col framed">
      <h5>{{ d.draft.name }}</h5>
    </div>
  </div>

  <div class="row mt-2 deckbuilder justify-content-center">
    <div class="col col-2 framed">
      <h5>Deck Info</h5>
      <ul class="list-unstyled">
        <li>
          Total:
          <span id="countMaindeck"></span>
        </li>
        <li>
          Lands:
          <span id="countLands"</span>
        </li>
        <li>
          Creatures:
          <span id="countCreatures"</span>
        </li>
        <li>
          Others:
          <span id="countOther"</span>
        </li>
      </ul>

      <h5>Deck Actions</h5>
      <ul class="list-unstyled">
        <li>
          <a href="#" id="saveLink">
            save
          </a>
        </li>
      </ul>
      
    </div>
    
    {{ card_column(d.card_set) }}
  </div>


  <!-- Card Image Popup -->
  <div class="d-none" id="autocardPopup" style="z-index: 500; right: 514px; bottom: 7px;">
    <div class="autocard-background">
      <div class="row no-gutters">
        <div class="position-relative">
          <img id="autocardImageFront" alt="">
        </div>
        <div class="position-relative">
          <img id="autocardImageBack" alt="" class="d-none">
        </div>
      </div>
    </div>
  </div>
  <!-- END: Card Image Popup -->

{% endblock content %}

{% block scripts %}
  <script>
   function update_counts() {
     let maindeckCount = $('.maindeck .card-list-item').length
     let sideboardCount = $('.sideboard .card-list-item').length

     $('#maindeckCount').text(maindeckCount)
     $('#sideboardCount').text(sideboardCount)

     let creatures = $('.maindeck li.creature').length
     let other = $('.maindeck li.other').length
     let land = $('.maindeck li.land-card').length

     $('#countMaindeck').text(maindeckCount)
     $('#countCreatures').text(creatures)
     $('#countOther').text(other)
     $('#countLands').text(land)
   }

   $(document).ready(function() {

     // Initialization
     update_counts()
     autocard_init('card-list-item')

     // Make the cards movable.
     $( ".sortable" ).sortable({
       connectWith: '.card-list',
       placeholder: 'sortable-highlight',
       start: function(e, ui){
         ui.placeholder.height(ui.item.height());
       },
       stop: update_counts
     });
     $( ".sortable" ).disableSelection();

     // Save the deck
     $("#saveLink").click(function() {
       let maindeck = $('.maindeck .card-list-item').map(function(){
         return $(this).text().trim()
       }).get()
       let sideboard = $('.sideboard .card-list-item').map(function(){
         return $(this).text().trim()
       }).get()

       let data = {
         maindeck: maindeck,
         sideboard: sideboard
       }

       $.ajax({
         type: 'POST',
         url: "{{ url_for('draft_deck_save', draft_id=d.draft.id) }}",
         data: data,
         success: function() {
           let msg_template = $('#messageTemplate').clone()
           msg_template.removeAttr('id')
           msg_template.removeClass('d-none')
           msg_template.find('p').text('Deck Saved')
           $('#flashMessages').append(msg_template)
         }
       })
     })
   })
  </script>
{% endblock scripts %}
