{% extends 'base.html' %}

{% from 'macros.html' import deckbuilder %}

{% block content %}
  <div class="row">
    <div class="col framed">
      <h5>{{ d.deck.name }}</h5>
      <a href="{{ url_for('draft', draft_id=d.draft.id) }}">back to draft</a>
    </div>
  </div>

  {{ deckbuilder(d) }}
  
  <div class="row mt-2 deckbuilder justify-content-center">
    <div class="col col-2 framed">
      <h5>Deck Info</h5>
      <ul class="list-unstyled">
        <li>
          Total:
          <span id="countMaindeck"></span>
        </li>
        <li>
          Creatures:
          <span id="countCreatures"</span>
        </li>
        <li>
          Others:

          <span id="countOther"</span>
        </li>
        <li>
          Lands:
          <span id="countLands"</span>
        </li>
      </ul>

      <h5>Deck Actions</h5>
      <ul class="list-unstyled">
        <li>
          <a href="#" id="saveLink">
            save
          </a>
        </li>
      </ul>
      
    </div>

    <div class="col col-2 framed">
      <h5>Basic Lands</h5>

      {% for basic in ['Forest', 'Island', 'Mountain', 'Plains', 'Swamp', 'Wastes'] %}
        <div class="basic-selector">
          <i class="far fa-plus-square basic-adjust basic-add"></i>
          <i class="far fa-minus-square basic-adjust basic-remove"></i>
          <span class="basic-type">{{ basic }}</span>
          ...
          <span class="basic-count">{{ d.basics(basic) }}</span>
        </div>
      {% endfor %}
      
    </div>

  </div>


{% endblock content %}

{% block scripts %}
  <script>
   function update_counts() {
     let creatures = $('#maindeckCreatures li').length
     let land = $('#maindeckOther li.card-type-land').length
     let other = $('#maindeckOther li').length - land

     var basic_land = 0
     $('.basic-count').each(function (i, elem) {
       basic_land += parseInt($(elem).text())
     })

     let total = creatures + other + land + basic_land

     $('#countMaindeck').text(total)
     $('#countCreatures').text(creatures)
     $('#countOther').text(other)
     $('#countLands').text(land + basic_land)
   }

   function basic_land_adjust() {
     let button = $(this)
     let parent = button.parent('.basic-selector')
     
     let diff = button.hasClass('basic-add') ? 1 : -1
     let count_span = parent.find('.basic-count')
     let count = Math.max(0, parseInt(count_span.text()) + diff)

     count_span.text(count)

     update_counts()
   }

   function build_deck_data() {
     let maindeck = $('#maindeck .card-list-item').map(function() {
       return $(this).data('card-id')
     }).get()
     
     let sideboard = $('#sideboard .card-list-item').map(function() {
       return $(this).data('card-id')
     }).get()

     let basics = $('.basic-selector').map(function() {
       let sel = $(this)
       let land = sel.find('.basic-type').text()
       let count = sel.find('.basic-count').text()
       return count + ' ' + land
     }).get()

     return {
       maindeck: maindeck,
       sideboard: sideboard,
       basics: basics
     }

   }

   $(document).ready(function() {

     // Initialization
     update_counts()
     autocard_init('card-list-item')

     // Make the cards movable.
     $(".sortable").sortable({
       connectWith: '.card-list',
       placeholder: 'sortable-highlight',
       start: function(e, ui){
         ui.placeholder.height(ui.item.height())
       },
       stop: update_counts
     })
     $( ".sortable" ).disableSelection()

     // Basic Land Selectors
     $('.basic-adjust').click(basic_land_adjust)
     $('.basic-selector').disableSelection()

     // Save the deck
     $("#saveLink").click(function() {
       let csrftoken = $('meta[name=csrf-token]').attr('content')

       $.ajaxSetup({
         beforeSend: function(xhr, settings) {
           if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
             xhr.setRequestHeader("X-CSRFToken", csrftoken)
           }
         }
       })       
       
       $.ajax({
         type: 'POST',
         url: "{{ url_for('draft_deck_save', draft_id=d.draft.id) }}",
         data: JSON.stringify(build_deck_data()),
         contentType: "application/json; charset=utf-8",
         success: function() {
           let msg_template = $('#messageTemplate').clone()
           msg_template.removeAttr('id')
           msg_template.removeClass('d-none')
           msg_template.find('p').text('Deck Saved')
           $('#flashMessages').append(msg_template)
         },
         error: function(error_message) {
           let msg_template = $('#messageTemplate').clone()
           msg_template.removeAttr('id')
           msg_template.removeClass('d-none')
           msg_template.removeClass('alert-success')
           msg_template.addClass('alert-danger')
           msg_template.find('p').text('Error: ' + error_message)
           console.log(error_message)
           $('#flashMessages').append(msg_template)
         }
       })
     })
   })
  </script>
{% endblock scripts %}
