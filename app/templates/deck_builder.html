{% extends 'base.html' %}

{% macro deckbuilder_row(id, cards) %}
  <div class="row deckbuilder-row" id="{{ id }}">
    {% for cmc in range(8) %}

      {# Cards under this header #}
      {% if cmc == 7 %}
        {% set cards = cards.cmc_gte(7) %}
        {% set cmc_string = '7+' %}
      {% else %}
        {% set cards = cards.cmc(cmc) %}
        {% set cmc_string = cmc|string %}
      {% endif %}

      <div class="col deckbuilder-col">
        <div class="m-0 border bg-light rounded">
          <div class="text-center">
            <p class="deckbuilder-col-header">{{ cmc_string }}</p>
          </div>
          <ul class="card-list sortable list-unstyled">
            {% for pack_card in cards %}
              {% set card = pack_card.cube_card %}

              <li
                class="card-list-item"
                data-pack-card-id="{{ pack_card.id }}"
                data-front="{{ card.image_front() }}"
                {% if card.image_back() %}
                  data-back="{{ card.image_back() }}"
                {% endif %}
              >
                {{ card.name() }}
              </li>            
            {% endfor %}
          </ul>
        </div>
      </div>
    {% endfor %}
  </div>
{% endmacro %}

{% macro deckbuilder(card_set) %}
  <h5 class="mb-0 mt-2">Main Deck</h5>
  {{ deckbuilder_row('maindeckCreatures', card_set.maindeck().creatures()) }}
  {{ deckbuilder_row('maindeckOther', card_set.maindeck().non_creature()) }}

  <h5 class="mb-0 mt-2">Sideboard</h5>
  {{ deckbuilder_row('sideboardCreatures', card_set.sideboard().creatures()) }}
  {{ deckbuilder_row('sideboardOther', card_set.sideboard().non_creature()) }}
{% endmacro %}


{% block content %}
  <div class="row">
    <div class="col framed">
      <h5>{{ d.draft.name }}</h5>
    </div>
  </div>

  {{ deckbuilder(d.card_set) }}
  
  <div class="row mt-2 deckbuilder justify-content-center">
    <div class="col col-2 framed">
      <h5>Deck Info</h5>
      <ul class="list-unstyled">
        <li>
          Total:
          <span id="countMaindeck"></span>
        </li>
        <li>
          Lands:
          <span id="countLands"</span>
        </li>
        <li>
          Creatures:
          <span id="countCreatures"</span>
        </li>
        <li>
          Others:
          <span id="countOther"</span>
        </li>
      </ul>

      <h5>Deck Actions</h5>
      <ul class="list-unstyled">
        <li>
          <a href="#" id="saveLink">
            save
          </a>
        </li>
      </ul>
      
    </div>

  </div>


  <!-- Card Image Popup -->
  <div class="d-none" id="autocardPopup" style="z-index: 500; right: 514px; bottom: 7px;">
    <div class="autocard-background">
      <div class="row no-gutters">
        <div class="position-relative">
          <img id="autocardImageFront" alt="">
        </div>
        <div class="position-relative">
          <img id="autocardImageBack" alt="" class="d-none">
        </div>
      </div>
    </div>
  </div>
  <!-- END: Card Image Popup -->

{% endblock content %}

{% block scripts %}
  <script>
   function update_counts() {
     let creatures = $('#maindeckCreatures li').length
     let other = $('#maindeckOther li').length
     let land = $('.maindeck li.land-card').length

     let total = creatures + other + land

     $('#countMaindeck').text(total)
     $('#countCreatures').text(creatures)
     $('#countOther').text(other)
     $('#countLands').text(land)
   }

   $(document).ready(function() {

     // Initialization
     update_counts()
     autocard_init('card-list-item')

     // Make the cards movable.
     $( ".sortable" ).sortable({
       connectWith: '.card-list',
       placeholder: 'sortable-highlight',
       start: function(e, ui){
         ui.placeholder.height(ui.item.height());
       },
       stop: update_counts
     });
     $( ".sortable" ).disableSelection();

     // Save the deck
     $("#saveLink").click(function() {
       let maindeck = $('.maindeck .card-list-item').map(function(){
         return $(this).data('pack-card-id')
       }).get()
       let sideboard = $('.sideboard .card-list-item').map(function(){
         return $(this).data('pack-card-id')
       }).get()

       let data = {
         maindeck: maindeck,
         sideboard: sideboard
       }

       $.ajax({
         type: 'POST',
         url: "{{ url_for('draft_deck_save', draft_id=d.draft.id) }}",
         data: JSON.stringify(data),
         contentType: "application/json; charset=utf-8",
         success: function() {
           let msg_template = $('#messageTemplate').clone()
           msg_template.removeAttr('id')
           msg_template.removeClass('d-none')
           msg_template.find('p').text('Deck Saved')
           $('#flashMessages').append(msg_template)
         },
         error: function(error_message) {
           let msg_template = $('#messageTemplate').clone()
           msg_template.removeAttr('id')
           msg_template.removeClass('d-none')
           msg_template.removeClass('alert-success')
           msg_template.addCass('alert-danger')
           msg_template.find('p').text('Error: ' + error_message)
           $('#flashMessages').append(msg_template)
         }
       })
     })
   })
  </script>
{% endblock scripts %}
