{% extends "base.html" %}

{% from "macros.html" import deckbuilder %}
{% from "macros.html" import show_draft_card_list %}
{% from "macros.html" import show_picked_card_names %}

{% macro seating_chart(d) %}
  <h2>Seating</h2>
  <table id="seating" class="table table-sm">
    <tr>
      <thead class="thead-light">
        <th></th>
        <th></th>
        <th colspan="{{ d.draft.num_packs }}">num picks made</th>
        <th></th>
      </thead>
      <thead class="thead-light">
        <th>player</th>
        <th>waiting</th>
        {% for pack in range(d.draft.num_packs) %}
          <th>{{ loop.index }}</th>
        {% endfor %}
        <th></th>
      </thead>
    </tr>

    <tbody>
      {% for s in d.seats %}
        <tr>
          <td>{{ s.user.name }}</td>
          <td>{{ s.waiting_packs()|length }}</td>
          {% for pack in range(d.draft.num_packs) %}
            <td>{{ s.num_picked_for_round(loop.index - 1) }}</td>
          {% endfor %}
          <td>
            <a href="{{ url_for('draft_force', draft_id=d.draft.id, user_id=s.user_id) }}">force</a>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% endmacro %}

{% macro match_results(d) %}
  <h3>Your Results</h3>
  <table class="table table-sm">
    <thead class="thead-light">
      <th>opponent</th>
      <th>results</th>
      <th></th>
    </thead>
    <tbody>
      {% for seat in d.seats %}
        {% if seat != d.seat %}
          {% set form = d.result_form_for(seat) %}
          <form action="{{ url_for('draft_result', draft_id=d.draft.id) }}" method="post" novalidate>
            {{ form.hidden_tag() }}
            {{ form.user_id() }}
            <tr>
              <td>{{ seat.user.name }}</td>
              <td>
                W{{ form.wins(size="3") }}
                L{{ form.losses(size="3") }}
                D{{ form.draws(size="3") }}
              </td>
              <td>{{ form.submit() }}</td>
            </tr>
          </form>
        {% endif %}
      {% endfor %}
    </tbody>
  </table>

  <h3>All Results</h3>
  <table class="table table-striped table-sm">
    <tbody>
      <tr>
        <td></td>
        {% for seat in d.seats %}
          <td>{{ seat.user.name }}</td>
        {% endfor %}
      </tr>
      
      {% for seat1 in d.seats %}
        <tr>
          <td>{{ seat1.user.name }}</td>
          {% for seat2 in d.seats %}
            <td>
              {% if seat1 == seat2 %}
                &times;
              {% else %}
                {{ d.results(seat1, seat2) }}
              {% endif %}
            </td>
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% endmacro %}


{% block content %}

  <div class="row">
    <!-- Draft Info -->
    <div class="col col-md-4 framed p-2">
      <ul class="list-unstyled">
        <li><strong>Draft: </strong>{{ d.draft.name }}</li>
        <li>
          <strong>Cube: </strong>
          <a href="{{ url_for('cube_cards', cube_id=d.draft.cube.id) }}">
            {{ d.draft.cube.name }}
          </a>
        </li>
        <li><strong>Packs: </strong>{{ d.draft.num_packs }}</li>
        <li><strong>Pack size: </strong>{{ d.draft.pack_size }}</li>
        {% if d.draft.scar_rounds_str %}
          <li><strong>Scar rounds: </strong>{{ d.draft.scar_rounds_str }}</li>
        {% endif %}
      </ul>

      <p class="text-secondary border-bottom mb-0">Cockatrice Custom Set</p>
      <a href="{{ url_for('cockatrice_download', draft_id=d.draft.id) }}">
        Download Cockatrice Custom Cards File
      </a>
      <br>
      <a href="{{ url_for('cockatrice_download', draft_id=d.draft.id, force_rebuild='true') }}">
        Rebuild File
      </a>
    </div>
    <!-- END: Draft Info -->

    <!-- Seating / Results -->
    <div class="col framed ml-2">
      {% if d.draft.complete %}
        {{ match_results(d) }}
      {% else %}
        {{ seating_chart(d) }}
      {% endif %}
    </div>
    <!-- END: Seating / Results -->

  </div>

  <div class="row mt-2">
    <!-- Draft Messages -->
    <div class="col col-md-4 framed">
      <h5>Messages</h5>
        {% for message in d.draft.messages|sort(attribute=timestamp, reverse=True) %}
          <p class="text-secondary text-s mb-1">{{ message.text }}</p>
        {% endfor %}
    </div>
    <!-- END: Draft Messages -->

    <!-- Face up cards -->
    {% if d.face_up_cards() %}
      <div class="col framed ml-2">
        <h5>Faceup Cards</h5>
        <div class="row ml-0 mr-0">
          {% for seat, cards in d.face_up_cards().items() %}
            <div class="col framed ml-2">
              <p class="mb-0"><strong>{{ seat.user.name }}</strong></p>
              {% for card in cards %}
                <p
                  class="card-list-item"
                  data-front="{{ card.cube_card.image_front() }}"
                  {% if card.cube_card.image_back() %}
                    data-back="{{ card.cube_card.image_back() }}"
                  {% endif %}
                >
                  {{ card.cube_card.name() }}
                </p>
              {% endfor %}
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
    <!-- END: Face up cards -->
  </div>

  <!-- Scars to Add -->
  {% if d.is_scarring_round() %}
    <div class="row">
      <div id="scars" class="col mt-2 framed bg-warning">
        <h3>Scarring Round</h3>
        {% for scar in d.pack.scar_options() %}
          <div class="m-2 p-2 framed row">
            <div class="col col-1 btn btn-success">
              Scar {{ loop.index }}
            </div>

            <div class="col">
              <ul class="list-unstyled mb-0">
                <li>{{ scar.text }}</li>
                <li class="text-secondary text-s ml-2">{{ scar.restrictions }}</li>
              </ul>
            </div>
          </div>
        {% endfor %}
        <a href="{{ url_for('draft_new_scars', draft_id=d.draft.id) }}">
          I need new scars
        </a>
      </div>
    </div>
  {% endif %}
  <!-- END: Scars to Add -->

  <!-- Card Picker -->
  {% if not d.draft.complete %}
    <div id="picker" class="no-gutters mt-2">
      <h2 class="text-primary">Card Picker</h2>
      {% if d.draft.complete %}
        <p>draft is complete</p>
      {% elif not d.pack %}
        <div class="btn btn-success">no packs waiting for you right now</div>
      {% else %}
        <p>
          Pack {{ d.pack.pack_number + 1 }} /
          Pick {{ d.pack.pick_number() }} /
          Passing to: {{ d.passing_to().name }}
        </p>

        {{ show_draft_card_list(d.pack.cards, d.draft.id) }}
      {% endif %}
    </div>
  {% endif %}
  <!-- END: Card Picker -->

  <!-- Picked Cards -->
  <div class="mt-2 pb-2 rounded border" style="background-color: #f5f5ff">
    {{ deckbuilder(d.deck_builder()) }}
  </div>

  <hr>

  {{ show_picked_card_names(d.seat) }}
  <!-- END: Picked Cards -->


  <!-- Draft Faceup Optional Modal -->
  <div class="modal fade" id="draftFaceUpModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">How do you want to draft this card?</h5>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        
        <div class="modal-body">
          <h6 id="cardName"></h6>
          <div class=" d-flex justify-content-between">
            <a id="pickFaceUp" class="btn btn-primary">Face Up</a>
            <a id="pickFaceDown" class="btn btn-secondary">Face Down</a>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- END: Draft Faceup Optional Modal -->  
{% endblock content %}


{% block scripts %}
  <script>
   $(document).ready(function() {
     $('#draftFaceUpModal').on('show.bs.modal', function (event) {
       let button = $(event.relatedTarget) // Button that triggered the modal
       let card_name = button.data('card-name')
       let card_id = button.data('card-id')

       let modal = $(this)

       let url = "/draft/" + {{ d.draft.id }} + "/pick/" + card_id + "?face_up="

       modal.find('#cardName').text(card_name)
       modal.find('#pickFaceUp').attr('href', url + 'true')
       modal.find('#pickFaceDown').attr('href', url + 'false')
     }) 
   })
  </script>

  <script>
   // Deck Builder


   function update_counts() {
     let creatures = $('#maindeckCreatures li').length
     let land = $('#maindeckOther li.card-type-land').length
     let other = $('#maindeckOther li').length - land

     var basic_land = 0
     $('.basic-count').each(function (i, elem) {
       basic_land += parseInt($(elem).text())
     })

     let total = creatures + other + land + basic_land

     $('#countMaindeck').text(total)
     $('#countCreatures').text(creatures)
     $('#countOther').text(other)
     $('#countLands').text(land + basic_land)
   }

   function basic_land_adjust() {
     let button = $(this)
     let parent = button.parent('.basic-selector')
     
     let diff = button.hasClass('basic-add') ? 1 : -1
     let count_span = parent.find('.basic-count')
     let count = Math.max(0, parseInt(count_span.text()) + diff)

     count_span.text(count)

     update_counts()
   }

   function build_deck_data() {
     let maindeck = $('#maindeck .card-list-item').map(function() {
       return $(this).data('card-id')
     }).get()
     
     let sideboard = $('#sideboard .card-list-item').map(function() {
       return $(this).data('card-id')
     }).get()

     let basics = $('.basic-selector').map(function() {
       let sel = $(this)
       let land = sel.find('.basic-type').text()
       let count = sel.find('.basic-count').text()
       return count + ' ' + land
     }).get()

     return {
       maindeck: maindeck,
       sideboard: sideboard,
       basics: basics
     }

   }

   function swap_maindeck_sideboard() {
     let li = $(this)
     let row = li.closest('#maindeck,#sideboard')
     let section = li.closest('.creature-row,.other-row')
     let col_header = li.parent().siblings('div').first().find('.deckbuilder-col-header').text()

     var new_row;
     if (row.attr('id') == 'maindeck') {
       new_row = row.siblings('#sideboard')
     }
     else {
       new_row = row.siblings('#maindeck')
     }

     var new_section;
     if (section.hasClass('creature-row')) {
       new_section = new_row.find('.creature-row')
     }
     else {
       new_section = new_row.find('.other-row')
     }

     let new_col = new_section.find('p:contains('+col_header+')').parent().siblings('ul').first()

     li.detach()
     li.appendTo(new_col)
   }

   $(document).ready(function() {

     // Initialization
     update_counts()
     autocard_init('card-list-item')

     // Make the cards movable.
     $(".sortable").sortable({
       connectWith: '.card-list',
       placeholder: 'sortable-highlight',
       start: function(e, ui){
         ui.placeholder.height(ui.item.height())
       },
       stop: update_counts
     })
     $( ".sortable" ).disableSelection()

     // Use double-click to swap between maindeck and sideboard
     $('.card-list-item').dblclick(swap_maindeck_sideboard)

     // Basic Land Selectors
     $('.basic-adjust').click(basic_land_adjust)
     $('.basic-selector').disableSelection()

     // Save the deck
     $("#saveLink").click(function() {
       let csrftoken = $('meta[name=csrf-token]').attr('content')

       $.ajaxSetup({
         beforeSend: function(xhr, settings) {
           if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
             xhr.setRequestHeader("X-CSRFToken", csrftoken)
           }
         }
       })       
       
       $.ajax({
         type: 'POST',
         url: "{{ url_for('draft_deck_save', draft_id=d.draft.id) }}",
         data: JSON.stringify(build_deck_data()),
         contentType: "application/json; charset=utf-8",
         success: function() {
           let msg_template = $('#messageTemplate').clone()
           msg_template.removeAttr('id')
           msg_template.removeClass('d-none')
           msg_template.find('p').text('Deck Saved')
           $('#flashMessages').append(msg_template)
         },
         error: function(error_message) {
           let msg_template = $('#messageTemplate').clone()
           msg_template.removeAttr('id')
           msg_template.removeClass('d-none')
           msg_template.removeClass('alert-success')
           msg_template.addClass('alert-danger')
           msg_template.find('p').text('Error: ' + error_message)
           console.log(error_message)
           $('#flashMessages').append(msg_template)
         }
       })
     })
   })
  </script>
{% endblock scripts %}
