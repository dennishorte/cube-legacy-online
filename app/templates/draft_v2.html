{% extends "base.html" %}


{% from "macros/deck_builder_v2.html" import deck_builder_v2 %}
{% from "macros/draft/pack_picker.html" import pack_picker %}
{% from "macros/draft/rotisserie_picker.html" import rotisserie_picker %}


{% block title_suffix %}
  Draft - {{ draft.name }}
{% endblock %}


{% block content %}
  {% set info = draft.info() %}


  <div class="row">

    <!-- Draft Info -->
    <div class="col col-md-4 framed p-2">
      <ul class="list-unstyled">
        <li>
          <div style="float: right;">
            <a href="#edit-draft-name-modal" class="btn btn-link text-s" onclick="show_name_editor()">
              edit
            </a>
          </div>
          <strong>Draft: </strong><span id="draft-name">{{ draft.name }}</span>
        </li>
        <li>
          <strong>State: </strong> {{ draft.state }}
        </li>
      </ul>

      <div id="round-info-wrapper">
        <strong>Rounds:</strong>
        {% for round in draft.info().rounds() %}
          <div class="round-info">
            {{ round['style'] }}

            {% if round['style'] == 'rotisserie' %}
              {% set keys = ['num_cards'] %}
            {% elif round['style'] == 'cube-pack' %}
              {% set keys = ['num_packs', 'pack_size', 'scar_rounds'] %}
            {% endif %}

            <ul>
              {% for key in keys %}
                <li>{{ key }}: {{ round[key] }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endfor %}

      </div>

      {% if draft.state == 'setup' %}
        <div id="setup-buttons">
          <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#round-add-modal">
            add round
          </button>

          <a href="{{ url_for('draft_v2_start', draft_id=draft.id) }}" class="btn btn-danger">
            start draft
          </a>
        </div>
      {% endif %}
    </div>
    <!-- END: Draft Info -->

    <!-- Seating / Results -->
    <div class="col framed ml-2">
      {% if draft.state == 'setup' %}
        <div style="float: right;">
          <button type="button" class="btn btn-success" data-toggle="modal" data-target="#user-add-modal">
            add users
          </button>
        </div>

        <h2>Players</h2>
        {% for user_id in info.user_ids() %}
          <p>{{ user_id }}</p>
        {% endfor %}

      {% else %}

        <h2>Seating</h2>
        <table class="table table-sm">
          <thead class="thead-light">
            <tr>
              <th>name</th>
              <th></th>
            </tr>
          </thead>

          <tbody>
            {% for user_id in info.user_ids() %}
              <tr>
                {% set user = info.user_data(user_id) %}
                <td>
                  {{ user['name'] }}
                  {% if user_id != current_user.id %}
                    (<a href="{{ url_for('game_draft_v2_fight', draft_id=draft.id, opp_id=user.id) }}">fight!</a>)
                  {% endif %}
                </td>

                <td>
                  <a href="{{ url_for('draft_v2_force', draft_id=draft.id, user_id=user_id) }}">force</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

      {% endif %}
    </div>
    <!-- END: Seating / Results -->

  </div>


  <!-- Card Picker -->
  <div class="row">
    <div class="col p-0">
      {% if draft.state == 'active' %}
        <h2 class="text-primary">Card Picker</h2>

        {% set round_style = draft.info().current_round(current_user)['style'] %}

        {% if round_style == 'cube-pack' %}
          {{ pack_picker(draft, current_user.id) }}
        {% elif round_style == 'rotisserie' %}
          Rotisserie Picker
          {{ rotisserie_picker(draft, current_user.id) }}
        {% else %}
          <h2 class="text-danger">Unsupported Round Style: {{ round_style }}</h2>
        {% endif %}
      {% elif draft.state == 'complete' %}
        <p>draft is finished</p>
      {% elif draft.state == 'killed' %}
        <h1>draft was killed</h1>
      {% else %}
        <!-- show nothing for other states -->
      {% endif %}
    </div>
  </div>
  <!-- END: Card Picker -->

  {% if draft.state != 'setup' %}
    {{ deck_builder_v2(draft, info.deck_info(current_user)) }}
  {% endif %}


  <div class="modal fade" id="edit-draft-name-modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Name</h5>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>

        <div class="modal-body">
          <input type="text" class="form-control" name="draft_name_input" id="draft-name-input">
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="submit_draft_name_update()">
            update
          </button>
        </div>
      </div>
    </div>
  </div>


  <div class="modal fade" id="user-add-modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Users</h5>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>

        <div class="modal-body">
          <select id="user-names-selector" class="form-control" multiple size="{{ all_users|length }}">
            {% for user in all_users %}
              <option value="{{ user.id }}">{{ user.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="user_add_submit()">
            add users
          </button>
        </div>
      </div>
    </div>
  </div>


  <div class="modal fade" id="round-add-modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Round</h5>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>

        <div class="modal-body">
          <div class="form-group">
            <div class="form-group">
              <label for="cube">Cube</label>
              <select id="round-cube-selector" name="cube" class="form-control">
                {% for cube in all_cubes %}
                  <option value="{{ cube.id }}">{{ cube.name }}</option>
                {% endfor %}
              </select>
            </div>

            <select id="round-type-selector" class="form-control" size="2">
              <option value="cube-pack">Cube Packs</option>
              <option value="rotisserie">Rotisserie</option>
            </select>
          </div>

          <div id="round-type-options">
            <div id="cube-pack-options" class="round-options d-none">
              <div class="form-group">
                <label for="pack_size">Pack Size</label>
                <input type="text" name="pack_size" class="form-control">
              </div>

              <div class="form-group">
                <label for="num_packs">Num Packs</label>
                <input type="text" name="num_packs" class="form-control">
              </div>

              <div class="form-group">
                <label for="scar_rounds">Scar Rounds</label>
                <input type="text" name="scar_rounds" class="form-control">
              </div>
            </div>

            <div id="rotisserie-options" class="round-options d-none">
              <div class="form-group">
                <label for="num_cards">Num Cards</label>
                <input type="text" name="num_cards" class="form-control">
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="round_add()">
            add round
          </button>
        </div>
      </div>
    </div>
  </div>
{% endblock content %}


{% block scripts %}
  <script>
   function fill_card_frames() {
     $('.closeup-card-wrapper').each(function() {
       if (!window.card_data)
         return

       let elem = $(this)
       let card_id = elem.data('card-id')
       let data = window.card_data[card_id]
       if (!data) {
         console.log(card_id)
         return
       }

       clo.util.draw_card_frame(elem, data)
     })
   }

   function round_add() {
     const link = "{{ url_for('draft_v2_round_add', draft_id=draft.id) }}"
     const cube_id = $('#round-cube-selector').val()
     const round_type = $('#round-type-selector').val()

     let params = `?style=${round_type}&cube_id=${cube_id}`

     const options_elem = $('#' + round_type + '-options')
     options_elem.find('input').each(function(idx, elem) {
       elem = $(elem)
       params += '&' + elem.attr('name') + '=' + elem.val()
     })

     window.location.href = link + params
   }

   function show_name_editor() {
     const draft_name = $('#draft-name').text()
     $('#draft-name-input').val(draft_name)
     $('#edit-draft-name-modal').modal('show')
   }

   function submit_draft_name_update() {
     let link = "{{ url_for('draft_v2_name_update', draft_id=draft.id) }}?name="
     link += $('#draft-name-input').val()
     window.location.href = link
   }

   function user_add_submit() {
     let link = "{{ url_for('draft_v2_user_add', draft_id=draft.id) }}?ids="
     link += $('#user-names-selector').val().join(',')
     window.location.href = link
   }

   $(document).ready(function() {
     window.card_data = {{ draft.info().card_data()|tojson }}
     fill_card_frames()
     init_deck_builder()
     autocard_init('card-list-item', true)

     $('#round-type-selector').change(function() {
       const round_type = $(this).val()
       $('.round-options').addClass('d-none')
       $('#' + round_type + '-options').removeClass('d-none')
     })

   })
  </script>
{% endblock scripts %}
